<div class="cart-page fade-in">
  <div class="page-header">
    <h1 class="page-title">
      CHECKOUT <span class="highlight">COMMAND CENTER</span>
    </h1>
    <div class="breadcrumbs">
      <a routerLink="/">STORE</a> <mat-icon>chevron_right</mat-icon> <span>CHECKOUT</span>
    </div>
  </div>

  @if (cartItems.length === 0) {
  <div class="empty-cart-state">
    <mat-icon class="empty-icon">shopping_cart_off</mat-icon>
    <h2>Seu carrinho está vazio</h2>
    <p>Parece que você ainda não adicionou nenhum equipamento ao seu setup.</p>
    <button class="continue-btn" (click)="continueShopping()">
      EXPLORAR LOJA
    </button>
  </div>
  } @else {
  <div class="cart-layout">

    <div class="main-content-column">
      <!-- Shipping Address Section -->
      <section class="checkout-section">
        <h2 class="section-title"><mat-icon>local_shipping</mat-icon> SHIPPING ADDRESS</h2>
        <form [formGroup]="addressForm" class="address-form-grid">

          <mat-form-field appearance="outline" class="col-span-1">
            <mat-label>CEP</mat-label>
            <input matInput formControlName="zipCode" placeholder="00000000" maxlength="8" (blur)="onZipCodeBlur()">
            <mat-error *ngIf="addressForm.get('zipCode')?.hasError('required')">CEP is required</mat-error>
            <mat-error *ngIf="addressForm.get('zipCode')?.hasError('pattern')">Invalid CEP</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-3">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="street">
            <mat-error *ngIf="addressForm.get('street')?.hasError('required')">Street is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-1">
            <mat-label>Number</mat-label>
            <input matInput formControlName="number" #numberInput>
            <mat-error *ngIf="addressForm.get('number')?.hasError('required')">Number is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-2">
            <mat-label>Complement</mat-label>
            <input matInput formControlName="complement" placeholder="Apt, Suite, etc. (optional)">
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-2">
            <mat-label>Neighborhood</mat-label>
            <input matInput formControlName="neighborhood">
            <mat-error *ngIf="addressForm.get('neighborhood')?.hasError('required')">Neighborhood is
              required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-2">
            <mat-label>City</mat-label>
            <input matInput formControlName="city">
            <mat-error *ngIf="addressForm.get('city')?.hasError('required')">City is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-span-1">
            <mat-label>State</mat-label>
            <input matInput formControlName="state" placeholder="UF" maxlength="2">
            <mat-error *ngIf="addressForm.get('state')?.hasError('required')">State is required</mat-error>
          </mat-form-field>
        </form>
      </section>

      <!-- Cart Items Section -->
      <section class="checkout-section">
        <h2 class="section-title"><mat-icon>inventory_2</mat-icon> ITEMS IN CART</h2>
        <div class="cart-items-list">
          @for (item of cartItems; track item.product.id) {
          <div class="cart-item-row">
            <div class="item-visual">
              @if (item.product.imageUrl) {
              <img [src]="item.product.imageUrl" [alt]="item.product.name">
              } @else {
              <div class="placeholder-img"><mat-icon>image</mat-icon></div>
              }
            </div>
            <div class="item-info">
              <h3>{{ item.product.name }}</h3>
              <div class="price">{{ item.product.price | currency:'BRL' }}</div>
            </div>
            <div class="item-actions">
              <div class="qty-selector">
                <button (click)="decrementQuantity(item)">-</button>
                <span>{{ item.quantity }}</span>
                <button (click)="incrementQuantity(item)">+</button>
              </div>
              <button mat-icon-button color="warn" (click)="removeItem(item)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          }
        </div>
      </section>
    </div>

    <!-- Order Summary -->
    <div class="summary-column">
      <div class="summary-card sticky-summary">
        <div class="summary-header">
          <mat-icon>receipt_long</mat-icon>
          <h2>ORDER SUMMARY</h2>
        </div>

        <div class="summary-rows">
          <div class="summary-row">
            <span>Subtotal</span>
            <span class="value">{{ subtotal | currency:'BRL' }}</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span class="value highlight-text">Calculated at next step</span>
          </div>
        </div>

        <div class="summary-total">
          <span>Total</span>
          <span class="total-value">{{ total | currency:'BRL' }}</span>
        </div>

        <button class="checkout-btn" (click)="finalizeOrder()" [disabled]="loading">
          @if (loading) {
          <span>PROCESSING...</span>
          } @else {
          <span>FINALIZE ORDER</span>
          <mat-icon>check_circle</mat-icon>
          }
        </button>

        <div class="secure-checkout">
          <mat-icon>lock</mat-icon> <span>Secure SSL Encrypted Transaction</span>
        </div>
      </div>
    </div>

  </div>
  }
</div>